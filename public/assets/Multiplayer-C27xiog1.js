var C=Object.defineProperty;var w=(u,e,s)=>e in u?C(u,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):u[e]=s;var l=(u,e,s)=>w(u,typeof e!="symbol"?e+"":e,s);import{d as F,u as b,h as g,i as R,s as m,k as D,b as E,j as v,e as x,w as O,F as T,g as A,r as P,o as M}from"./index-CqE5Q0FH.js";import{C as d,B as c,R as p,P as G,S,a as B,g as Y,G as V}from"./LocalTetris-v1l3vjnx.js";class j{constructor(e){l(this,"canvas");l(this,"ctx");l(this,"gameBoard");l(this,"fallingPiece");l(this,"nextPiece");l(this,"score");l(this,"isFastDropping");l(this,"animationFrameId");l(this,"isGameOver");l(this,"isPaused");l(this,"dropCounter");l(this,"lastTime");l(this,"moveSpeed");l(this,"dropSpeed");l(this,"fastDropSpeed");this.canvas=e,this.ctx=e.getContext("2d"),this.canvas.width=(d+6)*c,this.canvas.height=p*c,this.dropSpeed=500,this.fastDropSpeed=100,this.moveSpeed=150,this.gameBoard=Array.from({length:p},()=>Array(d).fill(0)),this.fallingPiece=null,this.nextPiece=null,this.score=0,this.isFastDropping=!1,this.animationFrameId=null,this.isGameOver=!1,this.isPaused=!1,this.dropCounter=0,this.lastTime=0}renderTile(e,s,a,t="black",i=2){this.ctx.fillStyle=a,this.ctx.fillRect(e*c,s*c,c,c),this.ctx.lineWidth=i,this.ctx.strokeStyle=t,this.ctx.strokeRect(e*c,s*c,c,c)}renderGameBoard(){this.gameBoard.forEach((s,a)=>{s.forEach((t,i)=>{const r=t?B[t-1]:"black",o=t?void 0:"rgba(255, 255, 255, 0.3)",n=t?void 0:.5;this.renderTile(i,a,r,o,n)})});const e=this.getGhostPosition();e&&e.shape.forEach((s,a)=>{s.forEach((t,i)=>{t>0&&this.renderTile(e.x+i,e.y+a,"black",this.fallingPiece.color)})}),this.fallingPiece!==null&&this.fallingPiece.drawPiece(),this.ctx.fillStyle="#1c1c1c",this.ctx.fillRect(d*c,0,6*c,6*c),this.ctx.strokeStyle="white",this.ctx.strokeRect(d*c,0,6*c,6*c),this.nextPiece&&this.nextPiece.drawPiece(!0)}collision(e,s,a=this.fallingPiece.shape){const t=a||this.fallingPiece.shape,i=this.getShapeBounds(t);for(let r=i.minY;r<=i.maxY;r++)for(let o=i.minX;o<=i.maxX;o++)if(t[r][o]>0){const n=e+o,h=s+r;if(n<0||n>=d||h>=p||h>=0&&this.gameBoard[h][n]>0)return!0}return!1}getShapeBounds(e){let s=e[0].length,a=0,t=e.length,i=0;for(let r=0;r<e.length;r++)for(let o=0;o<e[r].length;o++)e[r][o]>0&&(s=Math.min(s,o),a=Math.max(a,o),t=Math.min(t,r),i=Math.max(i,r));return{minX:s,maxX:a,minY:t,maxY:i}}getGhostPosition(){if(!this.fallingPiece)return null;let e=this.fallingPiece.y;for(;!this.collision(this.fallingPiece.x,e+1);)e++;return{x:this.fallingPiece.x,y:e,shape:this.fallingPiece.shape}}checkFilledLine(){let e=0;switch(this.gameBoard.forEach((s,a)=>{s.every(t=>t>0)&&(this.gameBoard.splice(a,1),this.gameBoard.unshift(Array(d).fill(0)),e++)}),e){case 1:this.score+=100;break;case 2:this.score+=300;break;case 3:this.score+=500;break;case 4:this.score+=800;break}}reset(){this.gameBoard=Array.from({length:p},()=>Array(d).fill(0)),this.fallingPiece=null;const e=Y(S.length);this.nextPiece=new G(this.ctx,S[e],B[e],Math.floor(d/2),0),this.score=0,this.isFastDropping=!1,this.isGameOver=!1,this.isPaused=!1,this.dropCounter=0,this.lastTime=0}start(){const e=s=>{if(this.isPaused||this.isGameOver)return;const a=s-this.lastTime;this.lastTime=s,this.dropCounter+=a,this.renderGameBoard(),this.animationFrameId=requestAnimationFrame(e)};requestAnimationFrame(e)}update(e){const{gameBoard:s,fallingPiece:a,nextPiece:t,score:i,isFastDropping:r,isGameOver:o,isPaused:n}=e;this.gameBoard=s,this.fallingPiece=a?new G(this.ctx,a.shape,a.color,a.x,a.y):null,this.nextPiece=new G(this.ctx,t==null?void 0:t.shape,t==null?void 0:t.color,t==null?void 0:t.x,t==null?void 0:t.y),this.score=i,this.isFastDropping=r,this.isGameOver=o,this.isPaused=n}}const I={class:"mt-14 flex justify-around items-center"},N=F({__name:"Multiplayer",setup(u){const e=b(),s=A(),a=g(),t=g(),i=g(null),r=g(!1);function o(){s.push("/")}return R(()=>{const n=new V(a.value,!1),h=new j(t.value);n.start(()=>{e.updateGameState({gameBoard:n.gameBoard,fallingPiece:n.fallingPiece,nextPiece:n.nextPiece,score:n.score,isFastDropping:n.isFastDropping,isGameOver:n.isGameOver,isPaused:n.isPaused}),n.isGameOver&&m.emit("game:gameOver")}),h.start(),m.on("game:updateOpponentState",f=>{h.update(f)}),m.on("game:gameOver",({winner:f})=>{r.value=!0,h.isGameOver=!0,n.isGameOver=!0,f===m.id?i.value="You":i.value="Opponent",m.emit("game:gameEnd")}),m.on("game:playerDisconnected",()=>{r.value=!0,h.isGameOver=!0,n.isGameOver=!0,i.value="You"})}),D(()=>{m.off("game:updateOpponentState"),m.off("game:gameOver"),m.off("game:playerDisconnected")}),(n,h)=>{const f=P("v-btn"),_=P("v-card"),k=P("v-dialog");return M(),E(T,null,[v("div",I,[v("canvas",{ref_key:"localGameCanvasRef",ref:a},null,512),v("canvas",{ref_key:"remoteGameCanvasRef",ref:t},null,512)]),x(k,{modelValue:r.value,"onUpdate:modelValue":h[0]||(h[0]=y=>r.value=y),persistent:!0,width:"auto"},{default:O(()=>[x(_,{width:"400",text:`贏家: ${i.value==="Opponent"?"對手":"你"}`},{actions:O(()=>[x(f,{class:"ms-auto",text:"Ok",onClick:o})]),_:1},8,["text"])]),_:1},8,["modelValue"])],64)}}});export{N as default};
